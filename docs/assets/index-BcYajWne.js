import{initializeApp as S}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import{getFirestore as D,doc as s,collection as p,setDoc as f,getDoc as y,addDoc as b,onSnapshot as g}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const c of e)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function n(e){const c={};return e.integrity&&(c.integrity=e.integrity),e.referrerPolicy&&(c.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?c.credentials="include":e.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(e){if(e.ep)return;e.ep=!0;const c=n(e);fetch(e.href,c)}})();const I={apiKey:"AIzaSyBlHOCK0h_cD2_SjWFBqBV7ODqJAfqHLF8",authDomain:"webrtc-webxr.firebaseapp.com",projectId:"webrtc-webxr",storageBucket:"webrtc-webxr.appspot.com",messagingSenderId:"253134015381",appId:"1:253134015381:web:c7ff945e621d615bbe449c",measurementId:"G-5LGETHTH9V"},B=S(I),l=D(B),v={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}],iceCandidatePoolSize:10},r=new RTCPeerConnection(v);let i=null,m=null;const h=document.getElementById("startBtn"),E=document.getElementById("joinBtn"),O=document.getElementById("vrBtn"),T=document.getElementById("localVideoStream"),w=document.getElementById("remoteVideoStream"),j=document.getElementById("localStream"),L=document.getElementById("remoteStream"),R=document.getElementById("vrScene"),u=document.getElementById("vrVideo");async function V(){j.style.display="block",i=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),i.getTracks().forEach(n=>r.addTrack(n,i)),T.srcObject=i;const t=s(p(l,"calls"));C(t,"offerCandidates");const o=await r.createOffer();await r.setLocalDescription(o),await f(t,{offer:{type:o.type,sdp:o.sdp}}),await f(s(l,"currentCall","activeCall"),{callId:t.id}),A(t)}async function k(){L.style.display="block",m=new MediaStream,r.ontrack=e=>e.streams[0].getTracks().forEach(c=>m.addTrack(c)),w.srcObject=m;const t=await q();if(!t)return;const o=s(l,"calls",t.callId);C(o,"answerCandidates");const n=(await y(o)).data();await r.setRemoteDescription(new RTCSessionDescription(n.offer));const a=await r.createAnswer();await r.setLocalDescription(a),await f(o,{answer:{type:a.type,sdp:a.sdp}},{merge:!0}),P(o,"offerCandidates")}function C(t,o){const n=p(t,o);r.onicecandidate=a=>{a.candidate&&b(n,a.candidate.toJSON())}}async function A(t){g(t,async o=>{const n=o.data();n!=null&&n.answer&&!r.currentRemoteDescription&&await r.setRemoteDescription(new RTCSessionDescription(n.answer))})}function P(t,o){const n=p(t,o);g(n,a=>{a.docChanges().forEach(e=>{e.type==="added"&&r.addIceCandidate(new RTCIceCandidate(e.doc.data()))})})}async function q(){const t=await y(s(l,"currentCall","activeCall"));return t.exists()?t.data():null}h.onclick=V;E.onclick=k;O.onclick=()=>{const t=w.srcObject;u.srcObject=t,u.onloadedmetadata=()=>{u.play(),R.style.display="block",document.querySelector("a-videosphere").setAttribute("src","#vrVideo")}};
